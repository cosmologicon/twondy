<!DOCTYPE html>
<title>Twondy and Zoop platformer prototype</title>
<canvas id=canvas>
<script src="http://ufx.space/UFX.js"></script>
<script>
"use strict"

let tau = 2 * Math.PI
// Normalize an angle to the range (-tau/2, tau/2)
let dX = (X) => ((X % tau + tau / 2) % tau) - tau / 2
let canvas = document.getElementById("canvas")
let context = canvas.getContext("2d")
UFX.draw.setcontext(context)
let sx, sy, s
UFX.maximize.onadjust = (canvas, width, height) => {
	sx = width
	sy = height
	s = Math.sqrt(sx * sy)
}
UFX.maximize(canvas, { aspects: [1] })
UFX.key.init()
UFX.key.watchlist = "up down left right space".split(" ")

UFX.ticker.init((dt) => {
	let kstate = UFX.key.state()
	let dkx = (kstate.pressed.right ? 1 : 0) - (kstate.pressed.left ? 1 : 0)
	let jump = kstate.down.up
	you.control(dkx, jump)
	state.objs.forEach(obj => obj.think(dt))
	view.think(dt)

	UFX.draw("fs #333 f0")
	
	UFX.draw("[")
	view.xform()
	state.drawworld()
	state.objs.forEach(obj => { context.save() ; obj.draw() ; context.restore() })
	UFX.draw("]")
})

let view = {
	// X is position angle increasing clockwise (to the right).
	X0: 0,
	// y is height in game units, starting at center of planet.
	y0: 100,
	// Game units per (0.001 * screen size).
	Z: 3,
	think: function (dt) {
		let dXt = dX(you.X + 40 / this.y0 * (you.right ? 1 : -1) - this.X0)
		let dyt = you.y + 20 - this.y0
		let ry = 400 * dt
		this.y0 += Math.abs(dyt) < ry ? dyt : dyt > 0 ? ry : -ry
		let rX = 400 / this.y0 * dt
		this.X0 += Math.abs(dXt) < rX ? dXt : dXt > 0 ? rX : -rX
	},
	xform: function () {
		let scale = this.Z / (0.001 * s)
		UFX.draw("t", sx / 2, sy / 2, "vflip z", scale, scale,
			"t", 0, -this.y0, "r", this.X0)
	},
}

let WorldBound = {
	draw: function () {
		UFX.draw("r", -this.X, "t", 0, this.y)
	},
}
let Boxy = {
	init: function (w, h) {
		this.w = w
		this.h = h
	},
	draw: function () {
		UFX.draw("tr", -this.w / 2, 0, this.w, this.h,
			"fs gray ss gray lw 1 [ alpha 0.5 f ] s")
	},
}
let YouPhysics = {
	init: function () {
		this.vx = 0
		this.vy = 0
		this.right = true
		this.state = states.grounded
		this.newstate = null
	},
	control: function (dkx, jump) {
		this.state.control.call(this, dkx, jump)
		this.resolvestate()
	},
	think: function (dt) {
		this.state.think.call(this, dt)
		this.resolvestate()
	},
	resolvestate: function () {
		if (this.newstate) {
			if (this.state.exit) this.state.exit.call(this)
			this.state = this.newstate
			this.newstate = null
			if (this.state.enter) this.state.enter.call(this)
		}
	},
}
let states = {
	grounded: {
		enter: function () {
			this.kjump = 0
			this.vy = 0
			this.y = state.R
		},
		control: function (dkx, jump) {
			if (dkx) this.right = dkx > 0
			this.vx = 100 * dkx
			if (jump) {
				this.kjump = 1
				this.newstate = states.spaceborne
				this.vy = 160
			}
		},
		think: function (dt) {
			this.vy = 0
			this.y = state.R
			this.X += this.vx / this.y * dt
		},
	},
	spaceborne: {
		control: function (dkx, jump) {
			if (dkx) this.right = dkx > 0
			this.vx = 100 * dkx
			if (jump && this.kjump < state.njump) {
				this.kjump += 1
				this.vy = 160
			}
		},
		think: function (dt) {
			let a = -400
			let y0 = this.y, X0 = this.X
			this.y += this.vy * dt + 0.5 * a * dt * dt
			this.vy += a * dt
			this.X += this.vx / this.y * dt
			if (this.vy < 0 && this.y <= state.R) this.newstate = states.grounded
			// TODO: test collide with platforms
		},
	},
}

let you = UFX.Thing()
	.addcomp(WorldBound)
	.addcomp(YouPhysics)
	.addcomp(Boxy, 20, 30)
you.X = 0
you.y = 100

let state = {
	R: 100,
	njump: 2,
	objs: [you],
	drawworld: function () {
		let grad = UFX.draw.lingrad(0, 100, 0, -100, 0, "#228", 1, "#282")
		UFX.draw("b o 0 0", this.R, "fs", grad, "f")
	}
}

</script>
